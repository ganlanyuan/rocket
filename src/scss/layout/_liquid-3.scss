@mixin holy-grail($key){
  $maps: args-get-maps($key);
  $map: false;
  $columns: false;
  $order: false;
  $child: args-get-next($key, 'child', 'div');
  $gutter: args-get-next($key, 'gutter', map-get($ro-layout, 'gutter'));
  $ie8: args-get($key, 'ie8', false);

  $global-bps: false;
  $bps: ();
  $condition: args-get($key, ('min' 'max'), 'min');
  $media-type: args-get($key, $ro-media-type);

  // get map
  @if length($maps) >= 1 {
    $map: nth($maps, 1);
  }
  @if length($maps) >= 2 {
    $global-bps: nth($maps, 2);
  }

  // if no map, use list
  @if length($maps) == 0 and type-of($key) == 'list' {
    @if not is-nested-list($key) {
      @if is-liquid-list($key) {
        $columns: $key;
      } @else {
        $child: $key;
      }
    } @else {
      @each $item in $key {
        @if type-of($item) == 'list' and not is-nested-list($item) {
          @if is-liquid-list($item) {
            $columns: $item;
          } @else {
            $child: $item;
          }
        }
      }
    }
  }
  
  @extend %clearfix;

  // using map
  // ('auto':1, 300px:0)
  // ('default': ('auto' 300px), 800px: ('auto':1, 300px:0));
  @if $map {

    // simple map: without breakpoint
    // ('auto':1, 300px:0)
    @if is-simple-map($map) {
      $columns: map-keys($map);
      $order: map-values($map);
      @include make-holy-grail($columns, $order, $child, $gutter, false);

      @if $ie8 {
        @include make-holy-grail($columns, $order, $child, $gutter, true);
      }

    // complex map: with breakpoints
    // ('default': ('auto' 300px), 800px: ('auto':1, 300px:0));
    } @else {
      @if $global-bps {
        $map: map-update-breakpoints($map, $global-bps);
      }
      $bps: map-keys($map);
      $bp-ie8: get-ie8-bp($bps, $condition);

      @for $i from 1 through length($bps) {
        $bp: nth($bps, $i);
        $layout: map-get($map, $bp);

        @if type-of($layout) == 'list' {
          $columns: $layout;
          @if not $order { $order: (1, 2, 3); }
        } @else if type-of($layout) == 'map' {
          $columns: map-keys($layout);
          $order: map-values(map-get($map, $bp));
        }

        @if $bp == 'default' or $bp == null {
          @include make-holy-grail($columns, $order, $child, $gutter, false);
        } @else {
          @include bp($condition $media-type $bp) {
            @include make-holy-grail($columns, $order, $child, $gutter, false);
          }
        }

        // generate ie8-only style
        @if $bp == $bp-ie8 {
          @include make-holy-grail($columns, $order, $child, $gutter, true);
        }
      }
    }
    
  // using list
  // ('auto' 300px)
  } @else {
    @if not $order { $order: (1, 2, 3); }
    @include make-holy-grail($columns, $order, $child, $gutter, false);

    @if $ie8 {
      @include make-holy-grail($columns, $order, $child, $gutter, true);
    }
  }

}

@mixin make-holy-grail($columns, $order, $child, $gutter, $ie8) {

  $child-list: ();
  $children-ie8: '';
  @if type-of($child) == 'string' {

    $child-list: ('#{$child}:nth-child(1)', '#{$child}:nth-child(2)', '#{$child}:nth-child(3)');
    $children-ie8: '.lt-ie9 #{&} > #{$child}';
  } @else if type-of($child) == 'list' and length($child) == 3 {

    $child-list: $child;
    $children-ie8: '.lt-ie9 #{&} > #{nth($child, 1)}, .lt-ie9 #{&} > #{nth($child, 2)}, .lt-ie9 #{&} > #{nth($child, 3)}'
  } 

  $positions: get-positions($order);
  $new-columns: ();
  @for $i from 1 through 3 {
    $new-columns: append($new-columns, nth($columns, nth($positions, $i)));
  }

  @if $ie8 {
    @at-root #{$children-ie8} {
      box-sizing: border-box;
      position: relative;
    }
  }

  // check gutter 
  @if unit($gutter) == '%' { $gutter: 0; }

  // flexible-column is on the left
  @if nth($columns, nth($positions, 1)) == null or nth($columns, nth($positions, 1)) == 'auto' {

    @for $i from 1 through length($new-columns) {
      $selector: if($ie8, 
        '.lt-ie9 & > .ie8-#{nth($positions, $i)}', 
        '> ' nth($child-list, nth($positions, $i))
        );

      #{$selector} {

        @if ($i == 1) {
          float: left;
          margin: 0 -100% 0 0;

          @if $ie8 {
            width: 100%;
            padding: 0 #{(nth($new-columns, 2) + nth($new-columns, 3) + $gutter * 2)} 0 0;
            z-index: 0;
          } @else {
            width: calc(100% - #{(nth($new-columns, 2) + nth($new-columns, 3) + $gutter * 2)});
          }

        } @else {
          float: right;
          width: nth($new-columns, $i);

          @if $i == 2 {
            margin: 0 (nth($new-columns, 3) + $gutter) 0 -100%;
          } @else {
            margin: 0 0 0 -100%;
          }

          @if $ie8 { 
            padding: 0; 
            z-index: 1;
          }
        }
      }
    }

  // flexible-column is on the middle
  } @else if nth($columns, nth($positions, 2)) == null or nth($columns, nth($positions, 2)) == 'auto' {

    @for $i from 1 through length($new-columns) {
      $selector: if($ie8, 
        '.lt-ie9 & > .ie8-#{nth($positions, $i)}', 
        '> ' nth($child-list, nth($positions, $i))
        );

      #{$selector} {

        @if ($i == 3) {
          float: right;
          width: nth($new-columns, $i);
          margin: 0 0 0 -100%;

          @if $ie8 { 
            padding: 0; 
            z-index: 1;
          }

        } @else {
          float: left;

          @if $i == 2 {

            @if $ie8 {
              width: 100%;
              padding: 0 #{(nth($new-columns, 3) + $gutter)} 0 #{(nth($new-columns, 1) + $gutter)};
              margin: 0 0 -100% 0;
              z-index: 0;
            } @else {
              width: calc(100% - #{(nth($new-columns, 1) + nth($new-columns, 3) + $gutter * 2)});
              margin: 0 -100% 0 #{(nth($new-columns, 1) + $gutter)};
            }

          } @else {
            width: nth($new-columns, $i);
            margin: 0 -100% 0 0;

            @if $ie8 { 
              padding: 0; 
              z-index: 1;
            }
          }
        }
      }
    }

  // flexible-column is on the right
  } @else if nth($columns, nth($positions, 3)) == null or nth($columns, nth($positions, 3)) == 'auto' {

    @for $i from 1 through length($new-columns) {
      $selector: if($ie8, 
        '.lt-ie9 & > .ie8-#{nth($positions, $i)}', 
        '> ' nth($child-list, nth($positions, $i))
        );

      #{$selector} {

        @if ($i == 3) {
          float: right;
          margin: 0 0 0 -100%;
          
          @if $ie8 {
            width: 100%;
            padding: 0 0 0 #{(nth($new-columns, 1) + nth($new-columns, 2) + $gutter * 2)};
            z-index: 0;
          } @else {
            width: calc(100% - #{(nth($new-columns, 1) + nth($new-columns, 2) + $gutter * 2)});
          }

        } @else {
          float: left;
          width: nth($new-columns, $i);

          @if $i == 2 {
            margin: 0 -100% 0 #{(nth($new-columns, 1) + $gutter)};
          } @else {
            margin: 0 -100% 0 0;
          }

          @if $ie8 { 
            padding: 0; 
            z-index: 1;
          }
        }
      }
    }
  }

}

@function get-positions($order) {
  $nums: list-increase(list-remove-duplicates($order)); // reordered values
  $positions: ();

  @each $num in $nums {
    @for $i from 1 through length($order) {
      @if nth($order, $i) == $num {
        $positions: append($positions, $i);
      }
    }
  }

  @return $positions;
}

@function get-ie8-bp($list, $condition) {
  @if type-of($list) == 'list' {

    $list-nums: ();
    @each $bp in $list {
      @if type-of($bp) == 'number' {
        $list-nums: append($list-nums, $bp);
      }
    }

    @if $condition == 'min' {
      @return max($list-nums...);

    } @else {

      @if index($list, null) {
        @return null;

      } @else if index($list, 'default') {
        @return 'default';

      } @else {
        @return max($list-nums...);
      }
    }
  } @else {
    @warn '"#{$list}" is not a list.'
  }
}

@mixin liquid-3($key) {
  @include holy-grail($key);
}