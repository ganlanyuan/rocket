@mixin gallery($key){
  @include check-arg-type($key, 'map');

  $layout: map-get($key, 'layout');
  $selector: if(map-get($key, 'selector'), map-get($key, 'selector'), 'li');
  $gutter: if(map-get($key, 'gutter'), map-get($key, 'gutter'), map-get($ro-layout, gutter));
  $direction: if(map-get($key, 'direction'), map-get($key, 'direction'), 'LTR');
  $center-align: map-get($key, 'center-align');
  $global-breakpoints: map-get($key, 'breakpoint');
  $local-breakpoints: false;
  $condition: if(map-get($key, 'condition'), map-get($key, 'condition'), 'min');
  $media-type: map-get($key, 'media-type');
  $keep: map-get($key, 'keep');

  // strip unit when gutter == 0
  $gutter: check-zero-value($gutter);
  $float: if($direction == 'LTR', left, right);
  @if $float == right { $center-align: false; }

  @if type-of($layout) == 'map' {
    // update $layout breakpoints
    @if $global-breakpoints { $layout: map-update-breakpoints($layout, $global-breakpoints); }
    @if $layout and type-of($layout) == 'map' { $local-breakpoints: map-keys($layout); }

    @if index($local-breakpoints, null) != null or index($local-breakpoints, 'default') != null { 
      $keep: false; 
    }

    @each $bp in $local-breakpoints {
      $this-per-row: map-get($layout, $bp);

      @if $bp == null or $bp == 'default' {
        @include gallery-base($selector, $gutter, $float, $center-align);
        $keep: true;

        @include make-gallery($this-per-row, $selector, $gutter, $float, $center-align);

      } @else if type-of($bp) == 'number' {
        @include bp( ('breakpoint': $bp, 'condition': $condition) ) {
          @if not $keep {
            @include gallery-base($selector, $gutter, $float, $center-align);
            $keep: true;
          }

          @include make-gallery($this-per-row, $selector, $gutter, $float, $center-align);
        }
      }
    }
  } @else {
    @if not $keep {
      @include gallery-base($selector, $gutter, $float, $center-align);
    }
    @include make-gallery($layout, $selector, $gutter, $float, $center-align);
  }
}

@mixin gallery-base($selector, $gutter, $float, $center-align){
  @if $center-align { 
    // Webkit: collapse white-space between units
    letter-spacing: -0.31em; 
    // Webkit: fixes text-rendering: optimizeLegibility
    text-rendering: optimizespeed; 
    // Sets the font stack to fonts known to work properly with the above letter
    // and word spacings. See: https://github.com/yahoo/pure/issues/41/
    // The following font stack makes gallery work on all known environments.
    // * FreeSans: Ships with many Linux distros, including Ubuntu
    // * Arimo: Ships with Chrome OS. Arimo has to be defined before Helvetica and
    //   Arial to get picked up by the browser, even though neither is available
    //   in Chrome OS.
    // * Droid Sans: Ships with all versions of Android.
    // * Helvetica, Arial, sans-serif: Common font stack on OS X and Windows.
    font-family: FreeSans, Arimo, "Droid Sans", Helvetica, Arial, sans-serif;

    // Opera as of 12 on Windows needs word-spacing.
    // The ".opera-only" selector is used to prevent actual prefocus styling
    // and is not required in markup.
    .opera-only :-o-prefocus, & { word-spacing: -0.43em; }
    text-align: center;
  } @else {
    @include clearfix(); 
  }

  @if unit($gutter) != '%' and $gutter != 0 { margin-right: - $gutter; }
  
  > #{$selector} {
    width: 100%;

    @if $center-align {
      display: inline-block;
      letter-spacing: normal;
      word-spacing: normal;
      vertical-align: top;
      text-rendering: auto;
      text-align: left;
    } @else {
      float: $float;
    }

    @if $gutter != 0 {
      @if unit($gutter) == '%' {
        margin: get-TRBL(#{opposite($float)} $gutter bottom $gutter);
      } @else {
        padding: 0 $gutter $gutter 0;
        @include box-sizing(border-box);
      }
    }
  }
}

@mixin make-gallery($columns, $selector, $gutter, $float, $center-align) {
  > #{$selector} { 
    @if unit($gutter) == '%' or $gutter == 0 {
      width: ((100% + $gutter) / $columns - $gutter); 
      
      // reset margin in each breakpoint
      &:nth-child(n) { margin-#{opposite($float)}: $gutter; }
      &:nth-child(#{$columns}n) { margin-#{opposite($float)}: 0; }

    } @else {
      width: percentage(1 / $columns); 
    }
    
    // reset clear in each breakpoint
    @if not $center-align {
      &:nth-child(n) { clear: none; }
      &:nth-child(#{$columns}n+1) { clear: both; }
    }

  }
}